<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="./vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Double 11 Global Shopping Festival Dashboard</title>
  <link rel="stylesheet" href="./src/styles/main.css" />
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;700&family=ZCOOL+QingKe+HuangYou&display=swap"
    rel="stylesheet">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* Back Button Styles */
    .back-button {
      position: absolute;
      top: 25px;
      right: 30px;
      z-index: 2000;
      padding: 8px 20px;
      background: rgba(10, 20, 40, 0.7);
      border: 1px solid #00eaff;
      color: #00eaff;
      text-decoration: none;
      font-family: "Microsoft YaHei", sans-serif;
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 0 10px rgba(0, 234, 255, 0.1);
      letter-spacing: 1px;
    }

    .back-button:hover {
      background: rgba(0, 234, 255, 0.15);
      box-shadow: 0 0 20px rgba(0, 234, 255, 0.4);
      text-shadow: 0 0 8px rgba(0, 234, 255, 0.6);
      transform: translateY(-1px);
    }

    /* Warehouse Detail Modal */
    .warehouse-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(5, 10, 20, 0.95);
      backdrop-filter: blur(10px);
      z-index: 3000;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      padding: 40px;
      box-sizing: border-box;
    }

    .warehouse-modal.active {
      display: block;
      opacity: 1;
    }

    .modal-content {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 30px;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: -20px;
      right: -20px;
      color: #00eaff;
      font-size: 24px;
      cursor: pointer;
      z-index: 3001;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid #00eaff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: rgba(0, 234, 255, 0.2);
      transform: rotate(90deg);
    }

    .modal-left {
      border-right: 1px solid rgba(0, 234, 255, 0.2);
      padding-right: 30px;
      color: #fff;
      overflow-y: auto;
    }

    .modal-right {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .detail-section {
      margin-bottom: 30px;
    }

    .detail-title {
      font-family: 'Orbitron', sans-serif;
      color: #00eaff;
      font-size: 1.1rem;
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(0, 234, 255, 0.3);
      padding-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .info-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 4px;
    }

    .info-label {
      color: #88a;
      font-size: 0.8rem;
      display: block;
      margin-bottom: 4px;
    }

    .info-value {
      color: #fff;
      font-size: 1rem;
      font-weight: bold;
    }

    .info-value.warning {
      color: var(--accent-orange);
    }

    .info-value.success {
      color: var(--success-green);
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(0, 234, 255, 0.1);
      border: 1px solid rgba(0, 234, 255, 0.3);
      border-radius: 4px;
      font-size: 0.8rem;
      color: #00eaff;
      cursor: pointer;
    }

    .modal-chart-container {
      flex: 1;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .modal-chart-area {
      flex: 1;
      width: 100%;
      position: relative;
    }



    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid;
      font-weight: bold;
      font-size: 0.9rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      background: rgba(0, 0, 0, 0.3);
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      display: inline-block;
    }

    .clickable-panel {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    }

    .clickable-panel:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 20px rgba(0, 234, 255, 0.3);
      border-color: rgba(0, 234, 255, 0.6);
    }
  </style>
</head>

<body>
  <div id="app">
    <a href="../index.html" class="back-button">
      <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"
        stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      返回大屏
    </a>
    <header class="dashboard-header">
      <h1><span class="festive-title">双11全球狂欢节</span></h1>
      <span class="subtitle">2025 GLOBAL SHOPPING FESTIVAL</span>
      <div class="header-decoration"></div>
    </header>

    <main class="dashboard-grid">
      <aside class="left-panel clickable-panel" id="left-panel" onclick="window.location.href='scheduling.html'"
        title="点击进入全局调度管理">
        <!-- Operations Components will be injected here -->
      </aside>

      <section class="center-panel" id="map-container">
        <!-- Map will be injected here -->
      </section>

      <aside class="right-panel clickable-panel" id="right-panel" onclick="window.location.href='analysis.html'"
        title="点击进入深度分析">
        <!-- Analytics Components will be injected here -->
      </aside>
    </main>

    <footer class="bottom-panel" id="bottom-panel">
      <!-- Real-time ticker will be injected here -->
    </footer>

    <!-- Warehouse Detail Modal -->
    <div id="warehouse-modal" class="warehouse-modal">
      <div class="modal-content">
        <div class="modal-close" onclick="closeWarehouseDetail()">×</div>

        <div class="modal-left">
          <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            <h2 id="modal-title"
              style="font-size: 2rem; color: #fff; margin: 0; text-shadow: 0 0 10px rgba(0,234,255,0.5);">上海一号仓</h2>
            <div id="modal-status-badge" class="status-badge">NORMAL</div>
          </div>

          <div class="detail-section">
            <div class="detail-title">基础信息</div>
            <div class="info-grid">
              <div class="info-item"><span class="info-label">总面积</span><span class="info-value" id="info-area">50,000
                  m²</span></div>
              <div class="info-item"><span class="info-label">可用容量</span><span class="info-value"
                  id="info-capacity">12,400 m²</span></div>
              <div class="info-item"><span class="info-label">当前库存</span><span class="info-value"
                  id="info-stock">75%</span></div>
              <div class="info-item"><span class="info-label">在岗人数</span><span class="info-value" id="info-staff">142
                  人</span></div>
            </div>
          </div>

          <div class="detail-section">
            <div class="detail-title">实时运营</div>
            <div class="info-grid">
              <div class="info-item"><span class="info-label">今日入库</span><span class="info-value" id="op-inbound">4,520
                  单</span></div>
              <div class="info-item"><span class="info-label">今日出库</span><span class="info-value" id="op-outbound">3,890
                  单</span></div>
              <div class="info-item"><span class="info-label">待处理订单</span><span class="info-value warning"
                  id="op-pending">125</span></div>
              <div class="info-item"><span class="info-label">作业效率</span><span class="info-value success"
                  id="op-efficiency">98.5%</span></div>
            </div>
          </div>

          <div class="detail-section">
            <div class="detail-title">调度关联</div>
            <div style="margin-bottom: 10px;">
              <span class="info-label">可支援仓库</span>
              <div style="display: flex; gap: 10px; margin-top: 5px;" id="support-warehouses">
                <span class="tag">杭州仓</span>
                <span class="tag">苏州仓</span>
                <span class="tag">南京仓</span>
              </div>
            </div>
            <div>
              <span class="info-label">本月被支援记录</span>
              <span class="info-value" id="support-history">15 次</span>
            </div>
          </div>
        </div>

        <div class="modal-right">
          <div class="modal-chart-container">
            <div class="detail-title">库存风险时序图表</div>
            <div id="inventory-chart" class="modal-chart-area"></div>
          </div>
          <div class="modal-chart-container">
            <div class="detail-title">调度网络拓扑图</div>
            <div id="network-chart" class="modal-chart-area"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // DataStream.js
    // ==========================================
    class DataStream {
      constructor() {
        this.listeners = [];
        this.intervalId = null;
      }

      subscribe(callback) {
        this.listeners.push(callback);
      }

      start() {
        this.intervalId = setInterval(() => {
          const data = this.generateData();
          this.notify(data);
        }, 5000); // Update every 5 seconds (slower)
      }

      stop() {
        clearInterval(this.intervalId);
      }

      notify(data) {
        this.listeners.forEach(listener => listener(data));
      }

      generateData() {
        // Static list of warehouses (extended)
        const cities = [
          { id: 'shanghai', name: 'Shanghai', lat: 31.2304, lon: 121.4737 },
          { id: 'guangzhou', name: 'Guangzhou', lat: 23.1291, lon: 113.2644 },
          { id: 'beijing', name: 'Beijing', lat: 39.9042, lon: 116.4074 },
          { id: 'newyork', name: 'New York', lat: 40.7128, lon: -74.0060 },
          { id: 'london', name: 'London', lat: 51.5074, lon: -0.1278 },
          { id: 'tokyo', name: 'Tokyo', lat: 35.6762, lon: 139.6503 },
          { id: 'sydney', name: 'Sydney', lat: -33.8688, lon: 151.2093 },
          { id: 'moscow', name: 'Moscow', lat: 55.7558, lon: 37.6173 },
          { id: 'cairo', name: 'Cairo', lat: 30.0444, lon: 31.2357 },
          { id: 'saopaulo', name: 'Sao Paulo', lat: -23.5505, lon: -46.6333 },
          { id: 'losangeles', name: 'Los Angeles', lat: 34.0522, lon: -118.2437 },
          { id: 'dubai', name: 'Dubai', lat: 25.2048, lon: 55.2708 },
          { id: 'frankfurt', name: 'Frankfurt', lat: 50.1109, lon: 8.6821 },
          { id: 'singapore', name: 'Singapore', lat: 1.3521, lon: 103.8198 },
          { id: 'mumbai', name: 'Mumbai', lat: 19.0760, lon: 72.8777 },
          { id: 'johannesburg', name: 'Johannesburg', lat: -26.2041, lon: 28.0473 },
          { id: 'paris', name: 'Paris', lat: 48.8566, lon: 2.3522 },
          { id: 'berlin', name: 'Berlin', lat: 52.5200, lon: 13.4050 },
          { id: 'bangkok', name: 'Bangkok', lat: 13.7563, lon: 100.5018 },
          { id: 'seoul', name: 'Seoul', lat: 37.5665, lon: 126.9780 },
          { id: 'jakarta', name: 'Jakarta', lat: -6.2088, lon: 106.8456 },
          { id: 'istanbul', name: 'Istanbul', lat: 41.0082, lon: 28.9784 },
          { id: 'mexicocity', name: 'Mexico City', lat: 19.4326, lon: -99.1332 },
          { id: 'toronto', name: 'Toronto', lat: 43.6532, lon: -79.3832 },
          { id: 'madrid', name: 'Madrid', lat: 40.4168, lon: -3.7038 },
          { id: 'chicago', name: 'Chicago', lat: 41.8781, lon: -87.6298 },
          { id: 'hongkong', name: 'Hong Kong', lat: 22.3193, lon: 114.1694 },
          { id: 'taipei', name: 'Taipei', lat: 25.0330, lon: 121.5654 },
          { id: 'riyadh', name: 'Riyadh', lat: 24.7136, lon: 46.6753 },
          { id: 'buenosaires', name: 'Buenos Aires', lat: -34.6037, lon: -58.3816 }
        ];

        const warehouses = cities.map(city => {
          const capacity = Math.floor(Math.random() * 58) + 40;
          let status = 'normal';
          if (capacity > 90) status = 'critical';
          else if (capacity > 75) status = 'warning';

          return { ...city, capacity, status };
        });

        const totalCapacity = warehouses.reduce((sum, w) => sum + w.capacity, 0);
        const avgUtilization = totalCapacity / warehouses.length;

        const routes = [
          { from: 'shanghai', to: 'newyork', volume: 'high', status: 'delayed' },
          { from: 'guangzhou', to: 'sydney', volume: 'medium', status: 'normal' },
          { from: 'beijing', to: 'moscow', volume: 'low', status: 'normal' },
          { from: 'tokyo', to: 'shanghai', volume: 'high', status: 'urgent' },
          { from: 'london', to: 'cairo', volume: 'medium', status: 'normal' },
          { from: 'losangeles', to: 'tokyo', volume: 'high', status: 'urgent' },
          { from: 'dubai', to: 'frankfurt', volume: 'high', status: 'normal' },
          { from: 'singapore', to: 'sydney', volume: 'medium', status: 'normal' },
          { from: 'mumbai', to: 'dubai', volume: 'medium', status: 'normal' },
          { from: 'newyork', to: 'london', volume: 'high', status: 'urgent' },
          { from: 'frankfurt', to: 'beijing', volume: 'medium', status: 'delayed' },
          { from: 'johannesburg', to: 'cairo', volume: 'low', status: 'normal' },
          { from: 'saopaulo', to: 'losangeles', volume: 'medium', status: 'warning' },
          { from: 'shanghai', to: 'losangeles', volume: 'high', status: 'normal' },
          { from: 'tokyo', to: 'sydney', volume: 'medium', status: 'normal' },
          { from: 'london', to: 'newyork', volume: 'high', status: 'normal' },
          { from: 'dubai', to: 'mumbai', volume: 'medium', status: 'normal' },
          { from: 'frankfurt', to: 'moscow', volume: 'low', status: 'normal' },
          { from: 'singapore', to: 'tokyo', volume: 'medium', status: 'normal' },
          { from: 'cairo', to: 'dubai', volume: 'medium', status: 'normal' },
          { from: 'sydney', to: 'losangeles', volume: 'high', status: 'urgent' },
          { from: 'beijing', to: 'tokyo', volume: 'high', status: 'normal' },
          { from: 'newyork', to: 'saopaulo', volume: 'medium', status: 'normal' },
          { from: 'moscow', to: 'london', volume: 'medium', status: 'normal' },
          { from: 'paris', to: 'berlin', volume: 'medium', status: 'normal' },
          { from: 'bangkok', to: 'singapore', volume: 'medium', status: 'normal' },
          { from: 'mexicocity', to: 'losangeles', volume: 'high', status: 'warning' },
          { from: 'toronto', to: 'newyork', volume: 'high', status: 'normal' },
          { from: 'madrid', to: 'paris', volume: 'medium', status: 'normal' },
          { from: 'jakarta', to: 'singapore', volume: 'medium', status: 'normal' },
          { from: 'buenosaires', to: 'saopaulo', volume: 'medium', status: 'normal' },
          { from: 'seoul', to: 'beijing', volume: 'high', status: 'urgent' },
          { from: 'istanbul', to: 'cairo', volume: 'medium', status: 'normal' },
          { from: 'chicago', to: 'newyork', volume: 'high', status: 'normal' },
          { from: 'hongkong', to: 'guangzhou', volume: 'high', status: 'urgent' },
          { from: 'taipei', to: 'hongkong', volume: 'medium', status: 'normal' },
          { from: 'riyadh', to: 'dubai', volume: 'medium', status: 'normal' },
        ];

        return {
          timestamp: new Date(),
          globalStats: {
            totalOrders: Math.floor(Math.random() * 1000000000) + 123000000,
            warehouseUtilization: avgUtilization,
            activeTrucks: Math.floor(Math.random() * 5000) + 1000,
          },
          warehouses: warehouses,
          routes: routes,
          events: [
            { time: new Date().toLocaleTimeString(), message: '订单 #774H 已送达上海分拨中心', type: 'success' },
            { time: new Date().toLocaleTimeString(), message: '高负载预警: 纽约转运中心负载率 > 90%', type: 'alert' },
            { time: new Date().toLocaleTimeString(), message: '新航线开通: 东京 - 上海 货运专线', type: 'info' },
            { time: new Date().toLocaleTimeString(), message: '实时: 广州仓出库效率提升 15%', type: 'success' },
            { time: new Date().toLocaleTimeString(), message: '延误: 伦敦-开罗 航班因天气延误', type: 'warning' },
          ]
        };
      }
    }

    // ==========================================
    // Map.js
    // ==========================================
    class MapComponent {
      constructor(containerId, dataStream) {
        this.containerId = containerId;
        this.container = document.getElementById(containerId);
        this.dataStream = dataStream;
        this.width = this.container.clientWidth;
        this.height = this.container.clientHeight;
        this.svg = null;
        this.projection = null;
        this.path = null;
        this.mapGroup = null;
        this.routesGroup = null;
        this.warehousesGroup = null;

        this.init();
      }

      async init() {
        this.svg = d3.select(`#${this.containerId}`)
          .append('svg')
          .attr('width', '100%')
          .attr('height', '100%')
          .attr('viewBox', `0 0 ${this.width} ${this.height}`)
          .style('background', 'transparent');

        this.mapGroup = this.svg.append('g').attr('class', 'map-layer');
        this.routesGroup = this.svg.append('g').attr('class', 'routes-layer');
        this.warehousesGroup = this.svg.append('g').attr('class', 'warehouses-layer');

        // Load GeoJSON
        try {
          const response = await fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson');
          const geoData = await response.json();
          this.renderMap(geoData);
          this.addLegend(); // Add legend after map render
        } catch (error) {
          console.error('Error loading map data:', error);
          this.container.innerHTML = '<div class="error">Map Data Loading Failed</div>';
        }

        // Subscribe to data updates
        this.dataStream.subscribe(this.update.bind(this));

        // Handle Resize
        window.addEventListener('resize', () => this.resize());
      }

      renderMap(geoData) {
        // Filter out Antarctica to save space
        const features = geoData.features.filter(d => d.properties.name !== 'Antarctica' && d.id !== 'ATA');

        this.projection = d3.geoMercator()
          .center([0, 25]) // Center North to move map down further
          .scale(100)
          .translate([this.width / 2, this.height / 2]);

        this.path = d3.geoPath().projection(this.projection);

        this.mapGroup.selectAll('path')
          .data(features) // Use filtered features
          .enter()
          .append('path')
          .attr('d', this.path)
          .attr('fill', '#0f4c81')
          .attr('stroke', '#1e3a8a')
          .attr('stroke-width', 0.5)
          .style('opacity', 0.9);
      }

      update(data) {
        if (!this.projection) return;

        // Update Warehouses
        const warehouses = this.warehousesGroup.selectAll('.warehouse')
          .data(data.warehouses, d => d.id);

        warehouses.exit().remove();

        const warehousesEnter = warehouses.enter()
          .append('g')
          .attr('class', 'warehouse')
          .style('cursor', 'pointer')
          .on('click', (event, d) => {
            openWarehouseDetail(d);
            event.stopPropagation();
          });

        warehousesEnter.append('circle')
          .attr('r', 4)
          .attr('fill', d => this.getWarehouseColor(d.status))
          .attr('stroke', '#fff')
          .attr('stroke-width', 1.5);

        // Add ripple effect for critical/warning
        warehousesEnter.filter(d => d.status !== 'normal')
          .append('circle')
          .attr('r', 4)
          .attr('fill', 'none')
          .attr('stroke', d => this.getWarehouseColor(d.status))
          .attr('stroke-width', 1)
          .attr('class', 'ripple')
          .append('animate')
          .attr('attributeName', 'r')
          .attr('from', 4)
          .attr('to', 12)
          .attr('dur', '1.5s')
          .attr('repeatCount', 'indefinite');

        warehousesEnter.filter(d => d.status !== 'normal')
          .select('.ripple')
          .append('animate')
          .attr('attributeName', 'opacity')
          .attr('from', 0.8)
          .attr('to', 0)
          .attr('dur', '1.5s')
          .attr('repeatCount', 'indefinite');

        // Update positions & styles
        const allWarehouses = warehouses.merge(warehousesEnter);

        // Update position
        allWarehouses.attr('transform', d => {
          const coords = this.projection([d.lon, d.lat]);
          return `translate(${coords[0]}, ${coords[1]})`;
        });

        // Update main circle color
        allWarehouses.select('circle:not(.ripple)')
          .attr('fill', d => this.getWarehouseColor(d.status));

        // Update ripples: remove all first, then add to those who need it
        allWarehouses.select('.ripple').remove();

        allWarehouses.filter(d => d.status !== 'normal')
          .append('circle')
          .attr('r', 4)
          .attr('fill', 'none')
          .attr('stroke', d => this.getWarehouseColor(d.status))
          .attr('stroke-width', 1)
          .attr('class', 'ripple')
          .append('animate')
          .attr('attributeName', 'r')
          .attr('from', 4)
          .attr('to', 12)
          .attr('dur', '1.5s')
          .attr('repeatCount', 'indefinite');

        allWarehouses.filter(d => d.status !== 'normal')
          .select('.ripple')
          .append('animate')
          .attr('attributeName', 'opacity')
          .attr('from', 0.8)
          .attr('to', 0)
          .attr('dur', '1.5s')
          .attr('repeatCount', 'indefinite');

        // Update Routes
        const routes = this.routesGroup.selectAll('.route')
          .data(data.routes, d => d.from + '-' + d.to);

        routes.exit().remove();

        const routesEnter = routes.enter()
          .append('path')
          .attr('class', 'route')
          .attr('fill', 'none')
          .attr('stroke-width', d => d.volume === 'high' ? 2 : 1)
          .attr('stroke-opacity', 0.6);

        this.routesGroup.selectAll('.route')
          .attr('stroke', d => this.getRouteColor(d.status))
          .attr('stroke-width', d => d.status === 'urgent' ? 3 : 2)
          .style('filter', d => `drop-shadow(0 0 ${d.status === 'urgent' ? '5px' : '3px'} ${this.getRouteColor(d.status)})`)
          .attr('d', d => {
            const source = data.warehouses.find(w => w.id === d.from);
            const target = data.warehouses.find(w => w.id === d.to);
            if (!source || !target) return null;
            return this.generateCurve(source, target);
          });
      }

      generateCurve(source, target) {
        const sourceCoords = this.projection([source.lon, source.lat]);
        const targetCoords = this.projection([target.lon, target.lat]);

        const dx = targetCoords[0] - sourceCoords[0];
        const dy = targetCoords[1] - sourceCoords[1];
        const dr = Math.sqrt(dx * dx + dy * dy);

        // Quadratic Bezier: Start, Control, End
        // Control point is perpendicular to the midpoint
        const midX = (sourceCoords[0] + targetCoords[0]) / 2;
        const midY = (sourceCoords[1] + targetCoords[1]) / 2;

        // Curve height depends on distance
        const curveHeight = dr * 0.2;

        // Calculate normal vector
        const normX = -dy / dr;
        const normY = dx / dr;

        const controlX = midX + normX * curveHeight;
        const controlY = midY + normY * curveHeight;

        return `M${sourceCoords[0]},${sourceCoords[1]} Q${controlX},${controlY} ${targetCoords[0]},${targetCoords[1]}`;
      }


      getWarehouseColor(status) {
        switch (status) {
          case 'critical': return '#ff3333'; // Red
          case 'warning': return '#ff9900'; // Orange
          default: return '#33ff33'; // Green
        }
      }

      getRouteColor(status) {
        switch (status) {
          case 'urgent': return '#ff3333'; // Red
          case 'delayed': return '#ff9900'; // Orange
          default: return '#00f2ff'; // Cyan
        }
      }

      addLegend() {
        const legendContainer = document.createElement('div');
        legendContainer.className = 'map-legend';
        legendContainer.innerHTML = `
                <div class="legend-title">图例</div>
                <div class="legend-section">
                    <div class="legend-subtitle">仓库状态</div>
                    <div class="legend-item"><span class="dot normal"></span>正常</div>
                    <div class="legend-item"><span class="dot warning"></span>警告</div>
                    <div class="legend-item"><span class="dot critical"></span>过载</div>
                </div>
                <div class="legend-section">
                    <div class="legend-subtitle">航线状态</div>
                    <div class="legend-item"><span class="line normal"></span>通畅</div>
                    <div class="legend-item"><span class="line delayed"></span>延误</div>
                    <div class="legend-item"><span class="line urgent"></span>加急</div>
                </div>
            `;
        this.container.appendChild(legendContainer);
      }

      resize() {
        this.width = this.container.clientWidth;
        this.height = this.container.clientHeight;
        this.svg.attr('viewBox', `0 0 ${this.width} ${this.height}`);
        if (this.projection) {
          this.projection.translate([this.width / 2, this.height / 2]);
          this.path.projection(this.projection);
          this.mapGroup.selectAll('path').attr('d', this.path);
        }
      }
    }

    // ==========================================
    // LeftPanel.js
    // ==========================================
    class LeftPanel {
      constructor(containerId, dataStream) {
        this.container = document.getElementById(containerId);
        this.dataStream = dataStream;
        this.init();
      }

      init() {
        this.container.innerHTML = `
          <div class="panel-card">
            <h3 class="panel-title">全局资源态势</h3>
            <div class="resource-status">
              <div class="status-header">
                <span>总仓利用率</span>
                <span class="highlight-value" id="utilization-text">0%</span>
              </div>
              <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="total-utilization" style="width: 0%"></div>
              </div>
              <div class="status-details">
                <div class="detail-item">
                  <span class="detail-number alert" id="high-load-count">0</span>
                  <span class="detail-label">高负载仓库</span>
                </div>
                <div class="detail-item">
                  <span class="detail-number success" id="idle-count">0</span>
                  <span class="detail-label">空闲资源仓库</span>
                </div>
              </div>
            </div>
          </div>

          <div class="panel-card">
            <h3 class="panel-title">实时调度监控 <span style="font-size:12px; float:right; color:#00eaff;">↗</span></h3>
            <div class="monitor-grid">
              <div class="monitor-row main">
                <span>今日调度任务总数</span>
                <span class="monitor-value blue" id="total-tasks">0</span>
              </div>
              <div class="monitor-row">
                <span>正在进行</span>
                <span class="monitor-value orange" id="active-tasks">0</span>
              </div>
              <div class="monitor-row">
                <span>等待执行</span>
                <span class="monitor-value" id="pending-tasks">0</span>
              </div>
            </div>
          </div>

          <div class="panel-card">
            <h3 class="panel-title">性能指标</h3>
            <div class="kpi-grid">
              <div class="kpi-row">
                <span class="kpi-label">平均响应时间 (ms)</span>
                <div class="kpi-data">
                  <span class="kpi-value blue" id="avg-response">0</span>
                  <span class="trend up">+1.2%</span>
                </div>
              </div>
              <div class="kpi-row">
                <span class="kpi-label">调度成功率 (%)</span>
                <div class="kpi-data">
                  <span class="kpi-value success" id="success-rate">99.9</span>
                  <span class="trend">保持高位</span>
                </div>
              </div>
              <div class="kpi-row">
                <span class="kpi-label">成本节约 (%)</span>
                <div class="kpi-data">
                  <span class="kpi-value orange">3.7</span>
                  <span class="trend">高于目标值</span>
                </div>
              </div>
            </div>
          </div>
        `;

        this.dataStream.subscribe(this.update.bind(this));
      }

      update(data) {
        // Update Utilization
        const util = data.globalStats.warehouseUtilization;
        const utilBar = document.getElementById('total-utilization');
        const utilText = document.getElementById('utilization-text');

        if (utilBar && utilText) {
          utilBar.style.width = `${util}%`;
          utilBar.style.backgroundColor = util > 90 ? 'var(--alert-red)' : (util > 70 ? 'var(--accent-orange)' : 'var(--accent-blue)');
          utilText.innerText = `${util.toFixed(1)}%`;
        }

        // Update Counts
        const highLoad = data.warehouses.filter(w => w.status === 'critical' || w.status === 'warning').length;
        const idle = data.warehouses.filter(w => w.status === 'normal').length;

        const highLoadEl = document.getElementById('high-load-count');
        const idleEl = document.getElementById('idle-count');
        if (highLoadEl) highLoadEl.innerText = highLoad;
        if (idleEl) idleEl.innerText = idle;

        // Update Tasks
        const totalTasks = Math.floor(data.globalStats.totalOrders / 100000);
        const activeTasks = data.globalStats.activeTrucks;

        const totalEl = document.getElementById('total-tasks');
        const activeEl = document.getElementById('active-tasks');
        const pendingEl = document.getElementById('pending-tasks');

        if (totalEl) totalEl.innerText = totalTasks.toLocaleString();
        if (activeEl) activeEl.innerText = activeTasks.toLocaleString();
        if (pendingEl) pendingEl.innerText = Math.floor(activeTasks * 0.5).toLocaleString();

        // Update KPI
        const avgRespEl = document.getElementById('avg-response');
        if (avgRespEl) avgRespEl.innerText = Math.floor(100 + Math.random() * 50);

        // Update Cost Savings (Mock data)
        const costSavingsEl = document.querySelector('.kpi-value.orange');
        if (costSavingsEl) {
          // Simulate slight fluctuation around 3.7
          const val = (3.7 + (Math.random() * 0.2 - 0.1)).toFixed(1);
          costSavingsEl.innerText = val;
        }
      }
    }

    // ==========================================
    // RightPanel.js
    // ==========================================
    class RightPanel {
      constructor(containerId, dataStream) {
        this.container = document.getElementById(containerId);
        this.dataStream = dataStream;
        this.init();
      }

      init() {
        this.container.innerHTML = `
          <div class="panel-card">
            <h3 class="panel-title">调度-轨迹对比</h3>
            <div id="chart-dispatch" class="chart-container"></div>
          </div>
          
          <div class="panel-card">
            <h3 class="panel-title">库存容量实时监控</h3>
            <div id="table-inventory" class="table-container">
              <table class="inventory-table">
                <thead>
                  <tr>
                    <th>仓库</th>
                    <th>容量</th>
                    <th>状态</th>
                  </tr>
                </thead>
                <tbody id="inventory-body"></tbody>
              </table>
            </div>
          </div>

          <div class="panel-card">
            <h3 class="panel-title">运输方式占比</h3>
            <div id="chart-transport" class="chart-container"></div>
          </div>
        `;

        this.renderCharts();
        this.dataStream.subscribe(this.update.bind(this));

        // Handle Resize
        window.addEventListener('resize', () => {
          // Debounce resize
          if (this.resizeTimeout) clearTimeout(this.resizeTimeout);
          this.resizeTimeout = setTimeout(() => this.renderCharts(), 200);
        });
      }

      renderCharts() {
        // Use requestAnimationFrame to ensure DOM is ready and layout is calculated
        requestAnimationFrame(() => {
          // Dispatch Chart (Dual Axis: Bar + Line)
          this.renderDispatchChart();
          // Transport Chart (Donut Chart with Legend)
          this.renderTransportChart();
          // Add Tooltip Container
          if (!document.getElementById('tooltip')) {
            const tooltip = document.createElement('div');
            tooltip.id = 'tooltip';
            tooltip.style.position = 'absolute';
            tooltip.style.visibility = 'hidden';
            tooltip.style.background = 'rgba(0,0,0,0.8)';
            tooltip.style.color = '#fff';
            tooltip.style.padding = '5px 10px';
            tooltip.style.borderRadius = '4px';
            tooltip.style.fontSize = '0.8rem';
            tooltip.style.pointerEvents = 'none';
            tooltip.style.zIndex = '1000';
            document.body.appendChild(tooltip);
          }
        });
      }

      renderDispatchChart() {
        const container = document.getElementById('chart-dispatch');
        if (!container) return;
        container.innerHTML = '';

        const margin = { top: 20, right: 20, bottom: 30, left: 40 };
        const rect = container.getBoundingClientRect();
        const width = (rect.width || 300) - margin.left - margin.right;
        const height = (rect.height || 200) - margin.top - margin.bottom;

        const svg = d3.select(container).append('svg')
          .attr('width', '100%')
          .attr('height', '100%')
          .attr('viewBox', `0 0 ${rect.width || 300} ${rect.height || 200}`)
          .append('g')
          .attr('transform', `translate(${margin.left},${margin.top})`);

        // Mock Data
        const data = [
          { range: '0-10m', standard: 120, actual: 140 },
          { range: '10-20m', standard: 132, actual: 130 },
          { range: '20-30m', standard: 101, actual: 125 },
          { range: '30-40m', standard: 134, actual: 145 },
          { range: '40-50m', standard: 90, actual: 110 },
        ];

        // X Axis
        const x = d3.scaleBand()
          .range([0, width])
          .domain(data.map(d => d.range))
          .padding(0.2);

        svg.append('g')
          .attr('transform', `translate(0,${height})`)
          .call(d3.axisBottom(x).tickSize(0))
          .selectAll('text')
          .style('fill', '#a0a0a0')
          .style('font-size', '0.7rem');

        svg.select('.domain').remove();

        // Y Axis Left (Bar)
        const y1 = d3.scaleLinear()
          .domain([0, 200])
          .range([height, 0]);

        svg.append('g')
          .call(d3.axisLeft(y1).ticks(5))
          .selectAll('text')
          .style('fill', '#a0a0a0');

        svg.selectAll('.domain, .tick line').style('stroke', '#333');

        // Bars
        svg.selectAll('.bar')
          .data(data)
          .enter()
          .append('rect')
          .attr('class', 'bar')
          .attr('x', d => x(d.range))
          .attr('width', x.bandwidth())
          .attr('y', d => y1(d.standard))
          .attr('height', d => height - y1(d.standard))
          .attr('fill', '#0099aa')
          .on('mouseover', function (event, d) {
            d3.select(this).attr('fill', '#00f2ff');
            const tooltip = document.getElementById('tooltip');
            tooltip.style.visibility = 'visible';
            tooltip.innerHTML = `标准: ${d.standard}<br>实际: ${d.actual}`;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 20 + 'px';
          })
          .on('mouseout', function () {
            d3.select(this).attr('fill', '#0099aa');
            document.getElementById('tooltip').style.visibility = 'hidden';
          });

        // Line (Actual)
        const line = d3.line()
          .x(d => x(d.range) + x.bandwidth() / 2)
          .y(d => y1(d.actual))
          .curve(d3.curveMonotoneX);

        svg.append('path')
          .datum(data)
          .attr('fill', 'none')
          .attr('stroke', '#ff3333')
          .attr('stroke-width', 2)
          .attr('d', line);

        // Dots
        svg.selectAll('.dot')
          .data(data)
          .enter()
          .append('circle')
          .attr('cx', d => x(d.range) + x.bandwidth() / 2)
          .attr('cy', d => y1(d.actual))
          .attr('r', 4)
          .attr('fill', '#ff3333')
          .attr('stroke', '#fff')
          .attr('stroke-width', 1);

        // Legend
        const legend = svg.append('g')
          .attr('transform', `translate(${width - 120}, -10)`);

        legend.append('rect').attr('width', 10).attr('height', 10).attr('fill', '#0099aa');
        legend.append('text').attr('x', 15).attr('y', 9).text('系统推荐').style('fill', '#fff').style('font-size', '0.7rem');

        legend.append('circle').attr('cx', 75).attr('cy', 5).attr('r', 4).attr('fill', '#ff3333');
        legend.append('text').attr('x', 85).attr('y', 9).text('实时轨迹').style('fill', '#fff').style('font-size', '0.7rem');
      }

      renderTransportChart() {
        const container = document.getElementById('chart-transport');
        if (!container) return;
        container.innerHTML = '';

        const rect = container.getBoundingClientRect();
        const width = rect.width || container.clientWidth || 300;
        const height = rect.height || container.clientHeight || 200;
        const radius = Math.max(0, Math.min(width, height) / 2 - 10);

        if (width <= 0 || height <= 0 || radius <= 0) return;

        const svg = d3.select(container).append('svg')
          .attr('width', '100%')
          .attr('height', '100%')
          .attr('viewBox', `0 0 ${width} ${height}`)
          .append('g')
          .attr('transform', `translate(${width * 0.35},${height / 2})`);

        const data = { '陆运': 45, '海运': 25, '空运': 30 };
        const color = d3.scaleOrdinal()
          .domain(Object.keys(data))
          .range(['#00f2ff', '#bc13fe', '#ff9900']);

        const pie = d3.pie().value(d => d[1]);
        const data_ready = pie(Object.entries(data));

        const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius);

        svg.selectAll('path')
          .data(data_ready)
          .enter()
          .append('path')
          .attr('d', arc)
          .attr('fill', d => color(d.data[0]))
          .attr('stroke', '#0b0f19')
          .style('stroke-width', '2px')
          .style('opacity', 0.8)
          .on('mouseover', function (event, d) {
            d3.select(this).style('opacity', 1).attr('transform', 'scale(1.05)');
            const tooltip = document.getElementById('tooltip');
            tooltip.style.visibility = 'visible';
            tooltip.innerHTML = `${d.data[0]}: ${d.data[1]}%`;
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY - 20 + 'px';
          })
          .on('mouseout', function () {
            d3.select(this).style('opacity', 0.8).attr('transform', 'scale(1)');
            document.getElementById('tooltip').style.visibility = 'hidden';
          });

        // Legend
        const legend = d3.select(container).select('svg').append('g')
          .attr('transform', `translate(${width * 0.65}, ${height * 0.3})`);

        Object.keys(data).forEach((key, i) => {
          const g = legend.append('g').attr('transform', `translate(0, ${i * 20})`);
          g.append('rect').attr('width', 10).attr('height', 10).attr('fill', color(key));
          g.append('text').attr('x', 15).attr('y', 9).text(key).style('fill', '#fff').style('font-size', '0.8rem');
        });
      }

      update(data) {
        // Update Inventory Table
        const tbody = document.getElementById('inventory-body');
        if (tbody) {
          tbody.innerHTML = '';
          const topWarehouses = [...data.warehouses].sort((a, b) => b.capacity - a.capacity).slice(0, 5);
          topWarehouses.forEach(w => {
            const statusText = {
              'critical': '过载',
              'warning': '警告',
              'normal': '正常'
            }[w.status] || w.status;

            const row = `
                <tr>
                  <td>${w.name}</td>
                  <td>${w.capacity}/100</td>
                  <td style="color: ${this.getStatusColor(w.status)}; font-weight: bold;">${statusText}</td>
                </tr>
              `;
            tbody.innerHTML += row;
          });
        }
      }

      getStatusColor(status) {
        switch (status) {
          case 'critical': return 'var(--alert-red)';
          case 'warning': return 'var(--accent-orange)';
          default: return 'var(--success-green)';
        }
      }
    }

    // ==========================================
    // BottomPanel.js
    // ==========================================
    class BottomPanel {
      constructor(containerId, dataStream) {
        this.container = document.getElementById(containerId);
        this.dataStream = dataStream;
        this.init();
      }

      init() {
        this.container.innerHTML = `
          <div class="ticker-content" id="ticker-content">
            <!-- Events will be injected here -->
          </div>
        `;
        this.dataStream.subscribe(this.update.bind(this));
      }

      update(data) {
        const ticker = document.getElementById('ticker-content');
        // In a real app, we'd append new events. For this demo, we'll just refresh the list or add if not present
        // To keep it simple and smooth, we'll just ensure the ticker has content

        if (ticker.children.length < 10) {
          data.events.forEach(event => {
            const span = document.createElement('span');
            span.className = `ticker-item ${event.type}`;
            span.innerText = `[${event.time}] ${event.message}`;
            ticker.appendChild(span);
          });
        }
      }
    }

    // ==========================================
    // Warehouse Detail Logic
    // ==========================================
    function closeWarehouseDetail() {
      document.getElementById('warehouse-modal').classList.remove('active');
    }

    function openWarehouseDetail(warehouse) {
      const modal = document.getElementById('warehouse-modal');
      document.getElementById('modal-title').innerText = warehouse.name + '详情';

      // Update Status Badge
      const badge = document.getElementById('modal-status-badge');
      const statusMap = {
        'critical': { text: 'CRITICAL', color: 'var(--alert-red)' },
        'warning': { text: 'WARNING', color: 'var(--accent-orange)' },
        'normal': { text: 'NORMAL', color: 'var(--success-green)' }
      };
      const statusInfo = statusMap[warehouse.status] || statusMap['normal'];

      badge.innerText = statusInfo.text;
      badge.style.color = statusInfo.color;
      badge.style.borderColor = statusInfo.color;
      badge.style.boxShadow = `0 0 8px ${statusInfo.color}40`;

      // Randomize data for demo
      document.getElementById('info-area').innerText = Math.floor(Math.random() * 50000 + 10000).toLocaleString() + ' m²';
      document.getElementById('info-capacity').innerText = Math.floor(Math.random() * 10000 + 5000).toLocaleString() + ' m²';
      document.getElementById('info-stock').innerText = Math.floor(Math.random() * 40 + 50) + '%';
      document.getElementById('info-staff').innerText = Math.floor(Math.random() * 200 + 50) + ' 人';

      document.getElementById('op-inbound').innerText = Math.floor(Math.random() * 5000 + 1000).toLocaleString() + ' 单';
      document.getElementById('op-outbound').innerText = Math.floor(Math.random() * 5000 + 1000).toLocaleString() + ' 单';
      document.getElementById('op-pending').innerText = Math.floor(Math.random() * 200);
      document.getElementById('op-efficiency').innerText = (90 + Math.random() * 10).toFixed(1) + '%';

      modal.classList.add('active');

      // Render Charts after modal is visible (for correct sizing)
      setTimeout(() => {
        renderInventoryChart();
        renderNetworkChart(warehouse.name);
      }, 100);
    }

    function renderInventoryChart() {
      const container = document.getElementById('inventory-chart');
      container.innerHTML = '';
      const width = container.clientWidth;
      const height = container.clientHeight;

      const svg = d3.select('#inventory-chart')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      const margin = { top: 20, right: 20, bottom: 30, left: 40 };
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;

      const g = svg.append('g').attr('transform', `translate(${margin.left},${margin.top})`);

      // Generate dummy time series data
      const data = [];
      for (let i = 0; i < 24; i++) {
        data.push({
          hour: i,
          inbound: Math.floor(Math.random() * 100),
          outbound: Math.floor(Math.random() * 100),
          stock: Math.floor(Math.random() * 50 + 50)
        });
      }

      const x = d3.scaleLinear().domain([0, 23]).range([0, innerWidth]);
      const y = d3.scaleLinear().domain([0, 150]).range([innerHeight, 0]);

      // Axes
      g.append('g').attr('transform', `translate(0,${innerHeight})`)
        .call(d3.axisBottom(x).ticks(6))
        .attr('color', '#88a');

      g.append('g').call(d3.axisLeft(y).ticks(5)).attr('color', '#88a');

      // Lines
      const lineIn = d3.line().x(d => x(d.hour)).y(d => y(d.inbound)).curve(d3.curveMonotoneX);
      const lineOut = d3.line().x(d => x(d.hour)).y(d => y(d.outbound)).curve(d3.curveMonotoneX);
      const lineStock = d3.line().x(d => x(d.hour)).y(d => y(d.stock)).curve(d3.curveMonotoneX);

      g.append('path').datum(data).attr('fill', 'none').attr('stroke', '#00eaff').attr('stroke-width', 2).attr('d', lineIn);
      g.append('path').datum(data).attr('fill', 'none').attr('stroke', '#ff3333').attr('stroke-width', 2).attr('d', lineOut);
      g.append('path').datum(data).attr('fill', 'none').attr('stroke', '#ffcc00').attr('stroke-width', 2).attr('stroke-dasharray', '5,5').attr('d', lineStock);

      // Legend
      const legend = svg.append('g').attr('transform', `translate(${width - 100}, 10)`);
      legend.append('rect').attr('x', 0).attr('y', 0).attr('width', 10).attr('height', 2).attr('fill', '#00eaff');
      legend.append('text').attr('x', 15).attr('y', 5).text('入库').attr('fill', '#ccc').style('font-size', '10px');

      legend.append('rect').attr('x', 0).attr('y', 15).attr('width', 10).attr('height', 2).attr('fill', '#ff3333');
      legend.append('text').attr('x', 15).attr('y', 20).text('出库').attr('fill', '#ccc').style('font-size', '10px');
    }

    function renderNetworkChart(centerName) {
      const container = document.getElementById('network-chart');
      // Clear previous interval if exists
      if (container.dataset.interval) {
        clearInterval(parseInt(container.dataset.interval));
      }
      container.innerHTML = '';

      const width = container.clientWidth;
      const height = container.clientHeight;

      const svg = d3.select('#network-chart')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      // Define gradients and markers
      const defs = svg.append('defs');

      // Arrow marker
      defs.append('marker')
        .attr('id', 'arrowhead')
        .attr('viewBox', '0 -5 10 10')
        .attr('refX', 25) // Position away from node center
        .attr('refY', 0)
        .attr('orient', 'auto')
        .attr('markerWidth', 6)
        .attr('markerHeight', 6)
        .append('path')
        .attr('d', 'M0,-5L10,0L0,5')
        .attr('fill', '#555');

      // Glow filter
      const filter = defs.append("filter")
        .attr("id", "glow");
      filter.append("feGaussianBlur")
        .attr("stdDeviation", "2.5")
        .attr("result", "coloredBlur");
      const feMerge = filter.append("feMerge");
      feMerge.append("feMergeNode").attr("in", "coloredBlur");
      feMerge.append("feMergeNode").attr("in", "SourceGraphic");

      const nodes = [
        { id: 'center', name: centerName, type: 'warehouse' },
        { id: 's1', name: '供应商A', type: 'supplier' },
        { id: 's2', name: '供应商B', type: 'supplier' },
        { id: 'c1', name: '客户X', type: 'customer' },
        { id: 'c2', name: '客户Y', type: 'customer' },
        { id: 'w1', name: '兄弟仓1', type: 'warehouse' },
      ];

      const links = [
        { source: 's1', target: 'center', type: 'supply' },
        { source: 's2', target: 'center', type: 'supply' },
        { source: 'center', target: 'c1', type: 'distribute' },
        { source: 'center', target: 'c2', type: 'distribute' },
        { source: 'center', target: 'w1', type: 'transfer' },
      ];

      const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-500))
        .force('center', d3.forceCenter(width / 2, height / 2));

      const link = svg.append('g')
        .selectAll('line')
        .data(links)
        .enter().append('line')
        .attr('stroke', '#333')
        .attr('stroke-width', 1)
        .attr('marker-end', 'url(#arrowhead)');

      const particleGroup = svg.append('g').attr('class', 'particles');

      const node = svg.append('g')
        .selectAll('g')
        .data(nodes)
        .enter().append('g')
        .call(d3.drag()
          .on("start", dragstarted)
          .on("drag", dragged)
          .on("end", dragended));

      node.append('circle')
        .attr('r', d => d.type === 'warehouse' && d.id === 'center' ? 25 : 12)
        .attr('fill', d => d.type === 'warehouse' ? '#00eaff' : (d.type === 'supplier' ? '#ffcc00' : '#ff3333'))
        .attr('stroke', '#fff')
        .attr('stroke-width', 2)
        .style('filter', 'url(#glow)');

      node.append('text')
        .text(d => d.name)
        .attr('x', 18)
        .attr('y', 5)
        .attr('fill', '#fff')
        .style('font-size', '12px')
        .style('text-shadow', '0 0 3px #000')
        .style('pointer-events', 'none');

      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });

      function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }

      // Particle Animation
      function emitParticle(l) {
        if (!l.source.x || !l.target.x) return; // Wait for simulation

        const color = l.type === 'supply' ? '#ffcc00' : (l.type === 'distribute' ? '#ff3333' : '#00eaff');
        const particle = particleGroup.append('circle')
          .attr('r', 3)
          .attr('fill', color)
          .attr('cx', l.source.x)
          .attr('cy', l.source.y)
          .style('filter', 'url(#glow)');

        particle.transition()
          .duration(1000 + Math.random() * 500)
          .ease(d3.easeLinear)
          .attr('cx', l.target.x)
          .attr('cy', l.target.y)
          .on('end', function () {
            d3.select(this).remove();
          });
      }

      const interval = setInterval(() => {
        links.forEach(l => {
          if (Math.random() > 0.3) { // 70% chance to emit per link per tick
            emitParticle(l);
          }
        });
      }, 800);

      container.dataset.interval = interval;
    }

    // ==========================================
    // Main Initialization
    // ==========================================
    // Initialize Data Stream
    const dataStream = new DataStream();

    // Initialize Components
    const map = new MapComponent('map-container', dataStream);
    const leftPanel = new LeftPanel('left-panel', dataStream);
    const rightPanel = new RightPanel('right-panel', dataStream);
    const bottomPanel = new BottomPanel('bottom-panel', dataStream);

    // Start Data Stream
    dataStream.start();

    console.log('Dashboard Initialized');
  </script>
</body>

</html>